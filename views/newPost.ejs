
<%# ---------------- Include Header Partial ---------------- %>
<%- include('partials/header', { title: 'Create Post', user: user }) %>

<style>
  /* Blog Post Form Styles */

.post-body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 40px 0;
}

.form-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    padding: 40px;
    max-width: 800px;
    margin: 0 auto;
}

.form-header {
    text-align: center;
    margin-bottom: 30px;
}

.form-header h1 {
    color: #667eea;
    font-weight: bold;
    margin-bottom: 10px;
}

.form-header p {
    color: #6c757d;
}

.btn-submit {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 12px 40px;
    font-weight: 600;
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn-submit:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.form-label {
    font-weight: 600;
    color: #495057;
}

textarea {
    resize: vertical;
}

/* File Upload Styles */
.file-upload-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
    width: 100%;
}

.file-upload-input {
    font-size: 100px;
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    cursor: pointer;
}

.file-upload-label {
    display: block;
    padding: 20px;
    background: #f8f9fa;
    border: 2px dashed #667eea;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload-label:hover {
    background: #e9ecef;
    border-color: #764ba2;
}

.file-upload-label i {
    font-size: 2rem;
    color: #667eea;
    margin-bottom: 10px;
}

.file-preview {
    margin-top: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.file-preview-item {
    position: relative;
    padding: 10px 15px;
    background: #e9ecef;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.file-preview-item .remove-file {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    padding: 0;
    line-height: 1;
}

.file-preview-item .remove-file:hover {
    background: #c82333;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .form-container {
        padding: 30px 20px;
        margin: 0 15px;
    }
    
    .post-body {
        padding: 20px 0;
    }
}


/*  Wrapper container for each image + remove button. */
.image-wrapper {
    position: relative;
    display: inline-block;
    margin: 5px;
}

.preview-img {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #ddd;
}

.remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    background: #ff4d4d;
    color: white;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    font-size: 16px;
    line-height: 18px;
    cursor: pointer;
    font-weight: bold;
}
.remove-btn:hover {
    background: #ff0000;
}

/* ------------- */

</style>

<div class="post-body">

  <div class="container">
        <div class="form-container">
            <div class="form-header">
                <h1>Create Blog Post</h1>
                <p>Share your thoughts with the world</p>
            </div>

            <!-- Success message -->
            <% if (typeof success !== 'undefined') { %>
            <div id="successMessage" class="alert alert-success mt-4" style="display: none;">
                <strong></strong>
            </div>
            <% } %>

            <!-- Error message from backend -->
            <% if (typeof error !== 'undefined') { %>
            <div class="alert alert-danger mt-4" >
                <strong><%= error %></strong>
            </div>
            <% } %>
            
            <form id="blogPostForm" action="/posts/add" method="POST"  enctype="multipart/form-data" onsubmit="return validationForm()" >
                

                <div class="mb-4">
                    <label for="postTitle" class="form-label">Post Title *</label>
                    <input 
                        type="text" 
                        class="form-control form-control-lg" 
                        id="postTitle" 
                        name="title"
                        placeholder="Enter your post title..." >
                    <!-- Error message -->
                    <div class="invalid-feedback">Title is required.</div>
                </div>
                

                <div class="mb-4">
                    <label for="postContent" class="form-label">Post Content *</label>
                    <textarea 
                        class="form-control" 
                        id="postContent" 
                        name="content"
                        rows="12" 
                        placeholder="Write your post content here..."></textarea>
                    <!-- Error message -->
                    <div class="invalid-feedback">Content is required.</div>
                    <div class="form-text">Write your blog post content in markdown or plain text.</div>
                </div>
                
                <!-- File Upload Section -->
                <div class="mb-4">
                <label for="image" class="form-label">Upload Files *</label>
                <div class="file-upload-wrapper">
                    <input multiple
                    type="file" 
                    class="file-upload-input" 
                    id="image" 
                    name="image"
                    multiple
                    accept="image/jpeg, image/png, image/jpg"
                    onchange="previewImages()" > <!-- onchange="handleFileSelect(event)" -->
                    <label for="postFiles" class="file-upload-label">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <strong>Click to upload</strong> or drag and drop
                    <div class="form-text mt-2">Images (JPEG, JPG, PNG - Max 10MB per file)</div>
                    </label>
                </div>
                <div id="filePreview" class="file-preview"></div>
                </div>


                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-submit">Publish Post</button>
                </div>
            </form>
            
            
        </div>
    </div>

</div>


<script>
//* Function to handle file selection and display a preview list
/* function handleFileSelect(event) {
    const files = event.target.files; // Get selected files from input
    const preview = document.getElementById('filePreview'); // Get the preview container
    preview.innerHTML = ''; // Clear previous previews

    // Loop through selected files and display each one
    Array.from(files).forEach((file, index) => {
        const fileItem = document.createElement('div'); // Create a div for each file preview
        fileItem.className = 'file-preview-item'; // Add CSS class for styling

        // Add file icon, name, size, and a remove (×) button
        fileItem.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" 
                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
            <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
            <button type="button" class="remove-file" onclick="removeFile(${index})">&times;</button>
        `;
        preview.appendChild(fileItem); // Add file preview item to the preview container
    });
}

//* Function to remove a file from the selected list
function removeFile(index) {
    const input = document.getElementById('postFiles'); // Get the file input element
    const dt = new DataTransfer(); // Create a new DataTransfer object (acts like a clipboard for files)
    const files = Array.from(input.files); // Convert FileList to an array

    // Re-add all files except the one with the specified index
    files.forEach((file, i) => {
        if (i !== index) dt.items.add(file);
    });

    input.files = dt.files; // Update input files with the remaining ones
    handleFileSelect({ target: input }); // Refresh preview after removal
} */


// Retrieve the success message sent from the backend via EJS.
// If 'success' is undefined, assign an empty string to avoid errors.
const successFromServer = "<%= typeof success !== 'undefined' ? success : '' %>";

// Check if there is a success message from the backend.
// If the message exists (not empty), we proceed to show it in the frontend.
if (successFromServer) {

    // Select the HTML element that will display the success message.
    const msgBox = document.getElementById("successMessage");

    // Make the success message visible by changing its CSS 'display' property from 'none' to 'block'.
    msgBox.style.display = "block";

    // Update the content of the <strong> tag inside the success message div
    // so that it shows the actual message sent from the backend.
    msgBox.querySelector("strong").innerText = successFromServer;

    // OPTIONAL: Automatically hide the success message after 3 seconds (3000 milliseconds)
    // This improves UX so the user doesn't have to manually dismiss it.
    setTimeout(() => {
        msgBox.style.display = "none"; // Hide the message after timeout
    }, 3000);
}


</script>

<script>
   
    /* function previewImages(){ 
        
        const preview = document.getElementById('filePreview');// Get the preview container where images will be displayed
        preview.innerHTML = ''; // Clear previous previews

        const files = document.getElementById('image').files; // Get all selected files from the input field with id="image"
        
         // * Loop through each selected file
        for( let i = 0; i < files.length; i++ ){

            const img = document.createElement( 'img' ); // Create an <img> element to display the preview
            img.src = URL.createObjectURL( files[i] ); // Convert the uploaded file into a temporary URL for preview
            img.classList.add( 'img-thumbnail', 'mr-2', 'mb-2' ); // Add Bootstrap CSS classes for styling
            img.style.maxWidth = '150px';  // Limit the preview image size
            img.style.objectFit = 'cover'; // Ensure image fills its box without stretching

            preview.appendChild( img ); // Append the generated <img> into the preview container

        }

    } */
    
    function previewImages() {
    
        const preview = document.getElementById('filePreview'); // Get the preview container where all image previews will appear
        preview.innerHTML = '';   // * Clear previous previews before showing new ones
        
        const input = document.getElementById('image');// * Get the <input type="file"> element
        const files = Array.from(input.files); // * Convert FileList into a real array for easy iteration

        // * Loop over each selected file
        files.forEach((file, index) => {

            // Create a wrapper div for both image + remove button
            const wrapper = document.createElement("div");
            wrapper.classList.add("image-wrapper");

            const img = document.createElement("img"); // Create an <img> element for showing the preview
            img.src = URL.createObjectURL(file); // Convert the file into a temporary URL so it can be shown in the browser
            img.classList.add("preview-img");  // Add styling classes for the preview image

             // Create a remove button (×)
            const removeBtn = document.createElement("button");
            removeBtn.innerHTML = "&times;";  // × icon
            removeBtn.classList.add("remove-btn");

           // When user clicks the remove button → remove the file at this index
            removeBtn.onclick = () => removeFile(index);

            // Append image + button into wrapper
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);

             // Add the completed preview box to the preview container
            preview.appendChild(wrapper);
        });
    }


    function removeFile(index) {

        const input = document.getElementById('image'); // Get the file input element (<input type="file">)
        
         // * Create a new DataTransfer object
        //   - This allows us to rebuild the file list after removing one file
        const dt = new DataTransfer();

        const files = Array.from(input.files); // Convert FileList into a real array so we can loop through it

        // Loop through all selected files
        files.forEach((file, i) => {
            if (i !== index) dt.items.add(file); // Add only the files that are NOT the removed index
        });

        input.files = dt.files;  // Replace old file list with the new one (without the removed file)

        previewImages(); // Re-render the preview section so UI updates immediately
    }


    function validationForm() {
        // Get the input fields
        const titleInput = document.getElementById('postTitle');
        const contentInput = document.getElementById('postContent');

        let isValid = true; // Flag to track form validity

        // Reset previous validation state
        titleInput.classList.remove('is-invalid');
        contentInput.classList.remove('is-invalid');

        // Check Title field
        if (!titleInput.value.trim()) {
            titleInput.classList.add('is-invalid'); // Red border + show invalid-feedback
            isValid = false;
        }

        // Check Content field
        if (!contentInput.value.trim()) {
            contentInput.classList.add('is-invalid'); // Red border + show invalid-feedback
            isValid = false;
        }

        // If invalid, prevent form submission
        return isValid;
    }

</script>

<%# ---------------- Include Footer Partial ---------------- %>
<%- include('partials/footer') %>
